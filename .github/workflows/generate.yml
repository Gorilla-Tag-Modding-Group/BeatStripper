name: Generate Stripped DLLs
on:
  workflow_dispatch:
    inputs:
      releaseTag:
        description: 'Release Tag'
        required: true
        default: 'v0.1.0'

jobs:
  generate:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - name: Setup MSBuild
      uses: warrenbuckley/Setup-MSBuild@v1
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: true
    - name: Install dependencies
      run: msbuild -t:restore
    - name: Build project
      run: msbuild BeatStripper.sln /t:Build /p:Configuration=Release

    - name: Setup SteamCMD
      uses: CyberAndrii/setup-steamcmd@v1.1.1
    - name: Download Gorilla Tag
      run: steamcmd +@sSteamCmdForcePlatformType windows +login ${{secrets.STEAM_USERNAME}} ${{secrets.STEAM_PASSWORD}} +force_install_dir $pwd/gorillatag +app_update 1533390 +quit

    - name: Generate Stripped DLLs
      run: .\BeatStripper\bin\Release\GorillaTagStripper.exe .\gorillatag\
    - name: Upload Stripped DLLs
      uses: actions/upload-artifact@v1
      with:
        name: Stripped-${{ github.sha }}
        path: ./stripped
    - name: Zip Files
      run: Compress-Archive -Path .\stripped\*.dll -DestinationPath .\compressed.zip

    - name: Make Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.releaseTag }}
        release_name: Release ${{  github.event.inputs.releaseTag }}
        body: |
          Automatic release for updated game files.
        draft: true
        prerelease: false

    - name: Add Files to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./compressed.zip
        asset_name: Stripped.zip
        asset_content_type: application/zip
